/*
 * Privilege Escalation via SUID Executable Vulnerability
 *
 * This demonstrates how a poorly designed SUID (Set-User-ID) program
 * can be exploited to gain root privileges.
 *
 * Security Learning Objectives:
 * 1. Understanding SUID bit and its security implications.
 * 2. Dangers of using system() or exec-family functions with user input.
 * 3. Importance of dropping privileges when not needed.
 * 4. Secure coding practices for privileged programs.
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>

void vulnerable_utility(char *user_command)
{
    char command_buffer[256];

    printf("Executing a 'safe' utility function...\n");

    // VULNERABILITY: The program uses system() with user-controllable data.
    // If this program is SUID root, it will execute any command as root.
    snprintf(command_buffer, sizeof(command_buffer), "ps %s", user_command);

    printf("Running command: %s\n", command_buffer);
    system(command_buffer);
}

void secure_utility()
{
    printf("Executing a secure utility function...\n");

    // SECURE: Drop privileges before executing anything.
    if (setuid(getuid()) != 0)
    {
        perror("setuid failed");
        return;
    }

    printf("Privileges dropped. Current UID: %d\n", getuid());

    // Now it's safer to run commands, though still risky.
    system("ps -ef | head -n 5");
}

int main(int argc, char *argv[])
{
    printf("=== SUID Privilege Escalation Demonstration ===\n");
    printf("Initial UID: %d, Effective UID: %d\n", getuid(), geteuid());

    if (argc != 2)
    {
        printf("Usage: %s <ps_options>\n\n", argv[0]);
        printf("To Exploit (if SUID root):\n");
        printf("  %s ';/bin/sh'\n", argv[0]);
        printf("  This will execute 'ps ;/bin/sh', spawning a root shell.\n");
        return 1;
    }

    vulnerable_utility(argv[1]);

    printf("\n=== Comparison with Secure Implementation ===\n");
    secure_utility();

    return 0;
}

/*
 * EXPLOITATION STEPS:
 *
 * 1. Compile the program:
 *    gcc setuid_exploit.c -o suid_exploit
 *
 * 2. Set ownership to root and add SUID bit (requires root):
 *    sudo chown root:root suid_exploit
 *    sudo chmod u+s suid_exploit
 *
 * 3. Verify permissions (should look like -rwsr-xr-x):
 *    ls -l suid_exploit
 *
 * 4. Run as a normal user to exploit:
 *    ./suid_exploit ';/bin/sh'
 *
 * 5. You should now have a root shell!
 *    # whoami
 *    root
 *
 * MITIGATION STRATEGIES:
 *
 * 1. Avoid SUID unless absolutely necessary.
 * 2. NEVER use system() in a privileged program.
 * 3. Use exec-family functions with full paths and without shell interpretation (e.g., execlp).
 * 4. Drop privileges as soon as they are no longer needed (setuid(getuid())).
 * 5. Sanitize all user input and environment variables.
 * 6. Compile with modern security flags.
 */
